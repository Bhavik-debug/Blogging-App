<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('./partials/head') %>
        <title>
            <%= blog.title %>
        </title>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

        <style>
            body {
                font-family: 'Rubik', sans-serif !important;
                background-color: rgb(221, 221, 201);
                color: #333;
                line-height: 1;
            }

            h1 {
                font-size: 3rem;
                font-weight: 600;
                margin-bottom: 20px;
                text-align: center;
                color: #111;
            }

            .blog-container {
                background: rgb(217, 235, 241);
                padding: 35px;
                border-radius: 12px;
                box-shadow: 0px 4px 22px rgba(0, 0, 0, 0.05);
                margin-top: 40px;
                margin-bottom: 60px;
            }

            .blog-cover {
                border-radius: 10px;
                margin-bottom: 25px;
            }

            pre.blog-body {
                white-space: pre-wrap;
                overflow-wrap: break-word;
                word-wrap: break-word;

                /* Typography improvements */
                font-size: 1.2rem;
                color: #2d2d2d;
                line-height: 1.9;
                font-weight: 400;

                /* Remove default <pre> background */
                background: none;
                border: none;
                padding: 0;
            }
            
            /* COMMENTS SECTION */
            .comment-box {
                position: relative;
                background: #fff;
                padding: 10px 14px;
                border-radius: 10px;
                box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.08);
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            /* profile image */
            .comment-user-img {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                object-fit: cover;
            }

            /* username + comment wrapper */
            .comment-body {
                display: flex;
                flex-direction: column;
                justify-content: center;
                max-width: 90%;
            }

            /* username */
            .comment-username {
                font-weight: 600;
                font-size: 0.95rem;
                color: #222;
                line-height: 1;
            }

            /* comment text */
            .comment-content {
                font-size: 0.9rem;
                color: #555;
                margin-top: 1px;
                white-space: pre-wrap;
            }

            /* DELETE BUTTON (right aligned) */
            .delete-btn {
                position: absolute;
                right: 12px;
                top: 12px;
                background: transparent;
                border: none;
                cursor: pointer;
                font-size: 18px;
                color: #3d2695;
                z-index: 10;
            }
        </style>
</head>

<body>

    <%- include('./partials/nav') %>

        <div class="container">
            <div class="blog-container">
                <h1>
                    <%= blog.title %>
                </h1>

                <img src="<%= blog.coverImageURL %>" class="img-fluid blog-cover" alt="<%= blog.title %>">

                <pre class="blog-body"><%= blog.body %></pre>

                <div class="box">
                    <img src="<%= blog.createdBy.profileImageURL %>" width="40px" alt="">
                    <u><b><i><%= blog.createdBy.fullName %></i></b></u>
                </div>
            </div>
        </div>

        <div class="container mt-3">

            <h3>Comments</h3>

            <!-- COMMENT FORM -->
            <% if (user) { %>
                <form action="/blog/comment/<%= blog._id %>" method="post">

                    <div class="mb-3">
                        <input type="text" class="form-control" name="content" placeholder="Enter your comment..."
                            required>
                    </div>

                    <button type="submit" class="btn btn-primary">Add</button>
                </form>

            <% } 
            else { %>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Please log in to comment" disabled>
                </div>
                <a href="/user/signin" class="btn btn-primary">Login to comment</a>
            <% } %>

            <!-- COMMENT LIST -->
            <div class="mt-4">
                <% comments.forEach(comment=> { %>
                    <div class="comment-box">
                        <img src="<%= comment.createdBy.profileImageURL %>" class="comment-user-img">

                        <div class="comment-body">
                            <div class="comment-username"><%= comment.createdBy.fullName %></div>
                            <div class="comment-content"><%= comment.content %></div>
                        </div>
                    
                        <% if (user && blog.createdBy && user.id === comment.createdBy._id.toString()) { %>
                            <form action="/blog/comment/<%= comment._id %>?_method=DELETE" method="POST">
                                <button class="delete-btn" type="submit"><i class="fa-solid fa-trash"></i></button>
                            </form>
                        <% } %>
                    </div>
                <% }) %>
            </div>

        </div>

        <%- include('./partials/scripts') %>
</body>

</html>